<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>丁類危評安衛預算系統 v9.7 (完整修復版)</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8f9fa; padding-bottom: 120px; }
        .header-bar { background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white; padding: 20px 0; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* 矩陣樣式 */
        .excel-header { background-color: #ffc107; color: #000; font-weight: bold; text-align: center; border: 1px solid #dee2e6; font-size: 0.9rem; vertical-align: middle; }
        .excel-sub-header { background-color: #fff3cd; color: #000; font-weight: bold; text-align: center; border: 1px solid #dee2e6; font-size: 0.85rem; vertical-align: middle; }
        .excel-cell { border: 1px solid #dee2e6; background-color: white; padding: 8px; vertical-align: middle; }
        
        /* 選項卡片 */
        .option-card { display: flex; align-items: center; border: 1px solid #dee2e6; border-radius: 4px; padding: 6px; background-color: #f8f9fa; height: 100%; transition: 0.2s; }
        .option-card:hover { border-color: #0d6efd; background-color: #e9ecef; }
        .option-card.active { background-color: #e8f0fe; border-color: #0d6efd; }
        
        /* 輸入框優化 */
        .contractor-input { width: 45px; height: 24px; font-size: 0.8rem; text-align: center; border: 1px solid #ced4da; margin-left: auto; border-radius: 3px; background-color: white; }
        
        /* 單價輸入框 (新功能) */
        .price-input { width: 100%; text-align: right; font-size: 0.9rem; border: 1px solid #ced4da; border-radius: 3px; padding: 2px 5px; }
        
        /* 預算表樣式 */
        .triggered-item { background-color: #e8f5e9 !important; border-left: 5px solid #198754; }
        .custom-item-row { background-color: #fff8e1 !important; border-left: 5px solid #ffc107; }
        
        .delete-cat-btn { color: #dc3545; background: none; border: none; font-size: 1.2rem; transition: 0.2s; padding: 0 10px; }
        .delete-cat-btn:hover { color: #bb2d3b; transform: scale(1.1); }
        
        .total-sticky { position: sticky; top: 0; z-index: 1020; background: white; border-bottom: 3px solid #0d6efd; padding: 10px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .floating-action { position: fixed; bottom: 30px; right: 30px; z-index: 1000; }
        .dashed-box { border: 2px dashed #ced4da; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: 0.3s; color: #6c757d; }
        .dashed-box:hover { border-color: #0d6efd; color: #0d6efd; background-color: #f8f9fa; }
        
        /* CPI 提示框 */
        .cpi-tip-box { font-size: 0.85rem; background-color: #e7f1ff; border-left: 4px solid #0d6efd; color: #084298; border-radius: 4px; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app">

    <div class="header-bar text-center">
        <div class="container">
            <h1><i class="bi bi-file-earmark-spreadsheet-fill"></i> 丁類危評安衛預算系統 v9.7</h1>
            <p class="mb-0 op-8">單價微調 + CPI 智慧指引版</p>
        </div>
    </div>

    <!-- 懸浮總價 -->
    <div class="total-sticky container-fluid text-center">
        <span class="h5 me-4">總計: <span class="text-danger fw-bold" style="font-size: 1.5rem;">{{ formatCurrency(grandTotal) }}</span></span>
        <span class="badge bg-primary">CPI: {{ cpiFactor }}</span>
    </div>

    <div class="container mt-4">
        
        <!-- 1. 基本資料 & CPI 指引 -->
        <div class="card shadow-sm mb-4 border-primary">
            <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-info-circle-fill"></i> 專案基本資料</span>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">工程名稱</label>
                        <input type="text" class="form-control" v-model="projectInfo.name" placeholder="例如：信義區商業大樓新建工程">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">合約安衛總預算</label>
                        <input type="text" class="form-control" v-model="projectInfo.totalBudget">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">工期(天)</label>
                        <input type="number" class="form-control" v-model="projectInfo.duration">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">高峰人數</label>
                        <input type="number" class="form-control" v-model="projectInfo.workers">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label fw-bold text-primary">CPI</label>
                        <input type="number" class="form-control border-primary fw-bold" v-model.number="cpiFactor" step="0.01">
                    </div>
                </div>

                <!-- CPI 智慧指引 -->
                <div class="cpi-tip-box mt-3">
                    <div class="fw-bold mb-1"><i class="bi bi-lightbulb-fill"></i> CPI 設定依據參考：</div>
                    <ul class="mb-0 ps-3">
                        <li><strong>台北市/新北市精華區</strong>：建議設為 <code>1.1 ~ 1.2</code> (工資高、運棄費高)。</li>
                        <li><strong>中南部或一般郊區</strong>：可維持預設值 <code>1.0</code>。</li>
                        <li><strong>遇到嚴重缺工潮</strong>：建議直接設為 <code>1.15</code> 以上以符行情。</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2. 工程特徵矩陣 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white fw-bold">
                <i class="bi bi-grid-3x3-gap-fill"></i> 工程詳細內容勾選表 (Scope Selection)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <!-- 第一列 -->
                        <tr>
                            <td class="excel-header" width="10%">施工方式</td>
                            <td class="excel-cell" width="23%">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="method" id="m1" value="順打" v-model="scope.method" checked>
                                    <label class="btn btn-outline-primary btn-sm" for="m1">順打</label>
                                    <input type="radio" class="btn-check" name="method" id="m2" value="逆打" v-model="scope.method">
                                    <label class="btn btn-outline-primary btn-sm" for="m2">逆打</label>
                                </div>
                            </td>
                            <td class="excel-header" width="10%">構造種類</td>
                            <td class="excel-cell" width="23%">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="struct" id="s1" value="鋼骨" v-model="scope.structure">
                                    <label class="btn btn-outline-secondary btn-sm" for="s1">鋼骨</label>
                                    <input type="radio" class="btn-check" name="struct" id="s2" value="SRC" v-model="scope.structure">
                                    <label class="btn btn-outline-secondary btn-sm" for="s2">SRC</label>
                                    <input type="radio" class="btn-check" name="struct" id="s3" value="RC" v-model="scope.structure">
                                    <label class="btn btn-outline-secondary btn-sm" for="s3">RC</label>
                                </div>
                            </td>
                            <td class="excel-header" width="10%">分階段</td>
                            <td class="excel-cell">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" v-model="scope.phasing.isPhased" id="phasingCheck" @change="syncBudget">
                                    <label class="form-check-label fw-bold text-primary" for="phasingCheck">分段送審</label>
                                </div>
                            </td>
                        </tr>

                        <!-- 第二列：假設工程 -->
                        <tr>
                            <td class="excel-header" colspan="6">假 設 工 程 (輸入數字 = 廠商數量)</td>
                        </tr>
                        <tr>
                            <td colspan="6" class="p-2 bg-white">
                                <div class="row row-cols-2 row-cols-md-5 g-2">
                                    <div class="col" v-for="(val, key) in scope.tempWorks" :key="key">
                                        <div class="option-card" :class="{ active: val.checked }">
                                            <div class="form-check mb-0">
                                                <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'temp'+key" @change="syncBudget">
                                                <label class="form-check-label small fw-bold" :for="'temp'+key">{{ val.label }}</label>
                                            </div>
                                            <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                        </div>
                                    </div>
                                </div>
                                <div class="excel-note mt-2 text-center text-danger">※ 勾選「塔吊」並輸入數量 2，下方預算表的「塔吊防碰撞」工項數量將自動設為 2。</div>
                            </td>
                        </tr>

                        <!-- 第三列：基礎工程 -->
                        <tr>
                            <td class="excel-header" colspan="6">基 礎 工 程 (輸入數字 = 廠商數量)</td>
                        </tr>
                        <tr>
                            <td class="excel-sub-header">擋土型式</td>
                            <td colspan="5" class="excel-cell">
                                <div class="row row-cols-2 row-cols-md-6 g-2">
                                    <div class="col" v-for="(val, key) in scope.foundation.walls" :key="key">
                                        <div class="option-card" :class="{ active: val.checked }">
                                            <div class="form-check mb-0">
                                                <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'wall'+key" @change="syncBudget">
                                                <label class="form-check-label small" :for="'wall'+key">{{ val.label }}</label>
                                            </div>
                                            <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="excel-sub-header">支撐型式</td>
                            <td colspan="5" class="excel-cell">
                                <div class="row row-cols-2 row-cols-md-6 g-2 align-items-center">
                                    <div class="col" v-for="(val, key) in scope.foundation.supports" :key="key">
                                        <div class="option-card" :class="{ active: val.checked }">
                                            <div class="form-check mb-0">
                                                <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'sup'+key" @change="syncBudget">
                                                <label class="form-check-label small" :for="'sup'+key">{{ val.label }}</label>
                                            </div>
                                            <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                        </div>
                                    </div>
                                    <div class="col-md-auto ms-2 text-muted small fst-italic">
                                        註：鋼板樁、鋼軌樁等統稱為擋土支撐廠商
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="excel-sub-header">其他項目</td>
                            <td colspan="5" class="excel-cell">
                                <div class="row row-cols-2 row-cols-md-6 g-2">
                                    <div class="col" v-for="(val, key) in scope.foundation.others" :key="key">
                                        <div class="option-card" :class="{ active: val.checked }">
                                            <div class="form-check mb-0">
                                                <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'foth'+key" @change="syncBudget">
                                                <label class="form-check-label small" :for="'foth'+key">{{ val.label }}</label>
                                            </div>
                                            <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        <!-- 第四列：結構/裝修 -->
                        <tr>
                            <td class="excel-header" colspan="6">結 構 與 裝 修 (輸入數字 = 廠商數量)</td>
                        </tr>
                        <tr>
                            <td colspan="6" class="p-2 bg-white">
                                <div class="row g-2">
                                    <!-- 結構 -->
                                    <div class="col-md-5 border-end pe-3">
                                        <h6 class="text-primary fw-bold border-bottom pb-1 mb-2">結構工程</h6>
                                        <div class="row row-cols-2 row-cols-md-3 g-2">
                                            <div class="col" v-for="(val, key) in scope.structural" :key="key">
                                                <div class="option-card" :class="{ active: val.checked }">
                                                    <div class="form-check mb-0">
                                                        <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'str'+key" @change="syncBudget">
                                                        <label class="form-check-label small" :for="'str'+key">{{ val.label }}</label>
                                                    </div>
                                                    <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 裝修 -->
                                    <div class="col-md-4 border-end px-3">
                                        <h6 class="text-success fw-bold border-bottom pb-1 mb-2">裝修工程</h6>
                                        <div class="row row-cols-2 g-2">
                                            <div class="col" v-for="(val, key) in scope.finishing" :key="key">
                                                <div class="option-card" :class="{ active: val.checked }">
                                                    <div class="form-check mb-0">
                                                        <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'fin'+key" @change="syncBudget">
                                                        <label class="form-check-label small" :for="'fin'+key">{{ val.label }}</label>
                                                    </div>
                                                    <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 設備 -->
                                    <div class="col-md-3 ps-3">
                                        <h6 class="text-secondary fw-bold border-bottom pb-1 mb-2">設備工程</h6>
                                        <div class="row row-cols-1 g-2">
                                            <div class="col" v-for="(val, key) in scope.equipment" :key="key">
                                                <div class="option-card" :class="{ active: val.checked }">
                                                    <div class="form-check mb-0">
                                                        <input class="form-check-input" type="checkbox" v-model="val.checked" :id="'eq'+key" @change="syncBudget">
                                                        <label class="form-check-label small" :for="'eq'+key">{{ val.label }}</label>
                                                    </div>
                                                    <input type="number" class="contractor-input" v-model.number="val.count" min="1" v-if="val.checked" @input="syncBudget" placeholder="1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. 法規危評條件 -->
        <div class="card mb-4 border-warning">
            <div class="card-header bg-warning bg-opacity-10 text-dark fw-bold">
                <i class="bi bi-exclamation-triangle-fill"></i> 法規危險性工作場所條件
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2" v-for="(type, index) in classDTypes" :key="index">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" :id="'type'+index" v-model="type.checked" @change="syncBudget">
                            <label class="form-check-label" :for="'type'+index">{{ type.label }}</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. 預算清單 (單價可編輯) -->
        <div class="accordion shadow-sm mb-3" id="budgetAccordion">
            <div class="accordion-item" v-for="(category, catKey) in itemDatabase" :key="catKey">
                <h2 class="accordion-header position-relative">
                    <button class="accordion-button" :class="{ collapsed: !category.isOpen }" type="button" @click="category.isOpen = !category.isOpen">
                        <span class="badge bg-primary me-2">{{ catKey }}</span> 
                        <span v-if="!category.isCustomCategory" class="fw-bold">{{ category.title }}</span>
                        <input v-else type="text" class="form-control form-control-sm d-inline-block w-50 fw-bold border-warning" v-model="category.title" @click.stop placeholder="請輸入分類名稱">
                        
                        <span class="ms-auto me-3 badge bg-light text-dark border">
                            小計: {{ formatCurrency(getCategoryTotal(catKey)) }}
                        </span>
                        
                        <button v-if="category.isCustomCategory" class="delete-cat-btn ms-2" @click.stop="removeMainCategory(catKey)" title="刪除此大項分類">
                            <i class="bi bi-trash3-fill"></i>
                        </button>
                    </button>
                </h2>
                <div class="accordion-collapse collapse" :class="{ show: category.isOpen }">
                    <div class="accordion-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%" class="text-center">選取</th>
                                        <th style="width: 25%">項目名稱</th>
                                        <th style="width: 8%" class="text-center">單位</th>
                                        <th style="width: 15%" class="text-center">基準單價 (可微調)</th>
                                        <th style="width: 10%" class="text-center">數量</th>
                                        <th style="width: 15%" class="text-end">複價 (含CPI)</th>
                                        <th style="width: 17%">備註 / 危害</th>
                                        <th style="width: 5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(item, idx) in category.items" :key="idx" :class="{ 'triggered-item': item.autoSelected, 'custom-item-row': item.isCustom }">
                                        <td class="text-center">
                                            <input class="form-check-input" type="checkbox" v-model="item.selected">
                                        </td>
                                        <td>
                                            <input v-if="item.isCustom" type="text" class="form-control form-control-sm" v-model="item.name" placeholder="輸入項目名稱">
                                            <span v-else>{{ item.name }}</span>
                                            <span v-if="item.autoSelected" class="badge bg-success small scale-80">連動</span>
                                            <span v-if="item.isCustom" class="badge bg-warning text-dark small scale-80">自訂</span>
                                        </td>
                                        <td class="text-center">
                                            <input v-if="item.isCustom" type="text" class="form-control form-control-sm text-center" v-model="item.unit">
                                            <span v-else>{{ item.unit }}</span>
                                        </td>
                                        <!-- 單價微調功能 -->
                                        <td class="text-center">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-white border-end-0">$</span>
                                                <input type="number" class="form-control text-end border-start-0" v-model.number="item.basePrice" min="0">
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <input type="number" class="form-control form-control-sm text-center mx-auto" style="width: 80px;" v-model.number="item.quantity" :disabled="!item.selected">
                                        </td>
                                        <td class="text-end fw-bold">
                                            {{ item.selected ? formatCurrency(Math.round(item.basePrice * cpiFactor) * item.quantity) : '-' }}
                                        </td>
                                        <td>
                                            <input type="text" class="form-control form-control-sm" v-model="item.note" :placeholder="item.risk || '備註'">
                                        </td>
                                        <td class="text-center">
                                            <i v-if="item.isCustom" class="bi bi-trash-fill delete-cat-btn fs-6" @click="removeCustomItem(catKey, idx)"></i>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="p-2 text-center border-top bg-light">
                                <button class="btn btn-sm btn-outline-secondary" @click="addCustomItem(catKey)">
                                    <i class="bi bi-plus-circle"></i> 新增 {{ catKey }} 類自訂工項
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增自訂大項 -->
        <div class="dashed-box mb-5" @click="addMainCategory">
            <i class="bi bi-plus-square-fill fs-4"></i><br>
            點擊此處新增「自訂大項分類」 (如：D. 交通維持、E. 環保設施)
        </div>

    </div>

    <div class="floating-action">
        <button class="btn btn-success btn-lg shadow rounded-pill px-4 py-3" @click="generateWord">
            <span class="h4 mb-0"><i class="bi bi-cloud-download-fill"></i> 輸出 Word 報表</span>
        </button>
    </div>

</div>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
<script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    const { createApp, ref, computed, reactive } = Vue;
    const { Document, Packer, Paragraph, Table, TableCell, TableRow, WidthType, HeadingLevel, AlignmentType, TextRun } = docx;

    createApp({
        setup() {
            const projectInfo = reactive({ name: '', totalBudget: '', duration: 365, workers: 50 });
            const cpiFactor = ref(1.0);

            // 1. 工程矩陣 (count default 1)
            const scope = reactive({
                method: '順打',
                structure: 'RC',
                phasing: { isPhased: false },
                tempWorks: {
                    power: { label: '臨時水電', checked: true, count: 1 },
                    scaf: { label: '施工架', checked: false, count: 1 },
                    elevator: { label: '施工電梯', checked: false, count: 1 },
                    crane: { label: '塔吊', checked: false, count: 1 },
                    hoarding: { label: '施工圍籬', checked: true, count: 1 }
                },
                foundation: {
                    walls: {
                        dw: { label: '連續壁', checked: false, count: 1 },
                        piles: { label: '擋土樁(預壘)', checked: false, count: 1 },
                        col: { label: '擋土柱', checked: false, count: 1 },
                        sheet: { label: '鋼板樁', checked: false, count: 1 },
                        rail: { label: '鋼軌樁', checked: false, count: 1 },
                        hshape: { label: '型鋼樁', checked: false, count: 1 }
                    },
                    supports: {
                        strut: { label: '型鋼支撐', checked: false, count: 1 },
                        anchor: { label: '地錨', checked: false, count: 1 }
                    },
                    others: {
                        base_pile: { label: '基樁', checked: false, count: 1 },
                        exc: { label: '土方開挖', checked: true, count: 1 },
                        platform: { label: '施工構臺', checked: false, count: 1 },
                        monitor: { label: '安全觀測', checked: true, count: 1 }
                    }
                },
                structural: {
                    steel: { label: '鋼構', checked: false, count: 1 },
                    form: { label: '模板', checked: true, count: 1 },
                    rebar: { label: '鋼筋', checked: true, count: 1 },
                    conc: { label: '混凝土', checked: true, count: 1 },
                    mep: { label: '水電配管', checked: false, count: 1 }
                },
                finishing: {
                    wp: { label: '防水', checked: false, count: 1 },
                    curtain: { label: '帷幕', checked: false, count: 1 },
                    stone: { label: '石材', checked: false, count: 1 }
                },
                equipment: {
                    elev: { label: '電梯', checked: false, count: 1 },
                    park: { label: '機械停車', checked: false, count: 1 }
                }
            });

            const classDTypes = reactive([
                { label: '建築物高度 80m 以上', checked: false, tags: ['high'] },
                { label: '開挖深度 18m 以上', checked: false, tags: ['deep'] },
                { label: '模板支撐高度 7m 以上', checked: false, tags: ['form7'] },
                { label: '橋梁工程', checked: false, tags: ['bridge'] },
                { label: '隧道工程', checked: false, tags: ['tunnel'] }
            ]);

            // 預算資料庫
            const itemDatabase = reactive({
                "A": {
                    title: "A. 假設工程", isOpen: true,
                    items: [
                        { name: "施工圍籬及安全標示", unit: "M", basePrice: 2500, quantity: 100, risk: "一般", selected: true, tags: ['hoarding'] },
                        { name: "臨時用電安全防護(漏電斷路器)", unit: "式", basePrice: 150000, quantity: 1, risk: "感電", selected: true, tags: ['power'] },
                        { name: "施工架防墜網/上下設備", unit: "M2", basePrice: 450, quantity: 2000, risk: "墜落", selected: false, tags: ['scaf', 'high'] },
                        { name: "施工電梯連動門/警報", unit: "座", basePrice: 25000, quantity: 1, risk: "機械", selected: false, tags: ['elevator'] },
                        { name: "塔吊防碰撞/防墜檢驗", unit: "座", basePrice: 65000, quantity: 1, risk: "倒塌", selected: false, tags: ['crane'] },
                        { name: "隧道/密閉空間氣體偵測器", unit: "組", basePrice: 85000, quantity: 2, risk: "中毒", selected: false, tags: ['tunnel', 'topdown'] },
                        { name: "分段審查行政作業費", unit: "式", basePrice: 20000, quantity: 1, risk: "行政", selected: false, tags: ['phasing'] }
                    ]
                },
                "B": {
                    title: "B. 基礎工程", isOpen: false,
                    items: [
                        { name: "連續壁導溝防護", unit: "M", basePrice: 800, quantity: 200, risk: "墜落", selected: false, tags: ['dw'] },
                        { name: "特種車輛(吊車/挖掘機)作業半徑管制", unit: "式", basePrice: 50000, quantity: 1, risk: "碰撞", selected: false, tags: ['dw', 'sheet', 'rail', 'hshape'] },
                        { name: "擋土支撐架設安全母索/通道", unit: "式", basePrice: 120000, quantity: 1, risk: "墜落", selected: false, tags: ['strut'] },
                        { name: "地錨抗拉試驗/防護", unit: "處", basePrice: 3000, quantity: 50, risk: "崩塌", selected: false, tags: ['anchor'] },
                        { name: "土方開挖車輛動線管制", unit: "式", basePrice: 60000, quantity: 1, risk: "碰撞", selected: false, tags: ['exc'] },
                        { name: "施工構臺護欄與承載計算", unit: "M", basePrice: 1500, quantity: 60, risk: "墜落", selected: false, tags: ['platform'] },
                        { name: "自動化監測(傾斜/水壓)", unit: "式", basePrice: 500000, quantity: 1, risk: "崩塌", selected: false, tags: ['monitor', 'deep'] },
                        { name: "基樁開孔防墜設施", unit: "處", basePrice: 1200, quantity: 20, risk: "墜落", selected: false, tags: ['base_pile'] }
                    ]
                },
                "C": {
                    title: "C. 結構與裝修", isOpen: false,
                    items: [
                        { name: "鋼骨吊裝防墜母索", unit: "噸", basePrice: 800, quantity: 500, risk: "墜落", selected: false, tags: ['steel'] },
                        { name: "模板開口防護/支撐檢驗", unit: "M2", basePrice: 150, quantity: 3000, risk: "倒塌", selected: false, tags: ['form'] },
                        { name: "系統式模板支撐(高7m以上)", unit: "M2", basePrice: 800, quantity: 500, risk: "倒塌", selected: false, tags: ['form7'] },
                        { name: "鋼筋搬運與防穿刺護套", unit: "式", basePrice: 30000, quantity: 1, risk: "穿刺", selected: false, tags: ['rebar'] },
                        { name: "通風換氣設備(隧道/逆打)", unit: "式", basePrice: 200000, quantity: 1, risk: "缺氧", selected: false, tags: ['tunnel', 'topdown'] },
                        { name: "帷幕吊掛/外牆作業防護", unit: "式", basePrice: 150000, quantity: 1, risk: "墜落", selected: false, tags: ['curtain', 'stone'] },
                        { name: "電梯井開口與施工平臺防護", unit: "座", basePrice: 15000, quantity: 2, risk: "墜落", selected: false, tags: ['elev', 'mep'] },
                        { name: "機械停車坑洞防護", unit: "座", basePrice: 5000, quantity: 1, risk: "墜落", selected: false, tags: ['park'] }
                    ]
                }
            });

            // 大項增刪
            const addMainCategory = () => {
                const keys = Object.keys(itemDatabase);
                const lastKey = keys[keys.length - 1]; 
                let nextCode = "D";
                if(lastKey.length === 1 && lastKey >= 'A' && lastKey < 'Z') nextCode = String.fromCharCode(lastKey.charCodeAt(0) + 1);
                else nextCode = "CAT_" + (keys.length + 1);
                
                itemDatabase[nextCode] = {
                    title: `${nextCode}. 自訂分類(可更名)`, isOpen: true, isCustomCategory: true, items: []
                };
                addCustomItem(nextCode);
            };

            const removeMainCategory = (key) => {
                if(confirm(`確定要刪除整個「${itemDatabase[key].title}」分類及其下所有工項嗎？`)) delete itemDatabase[key];
            };

            const addCustomItem = (catKey) => {
                itemDatabase[catKey].items.push({ name: "", unit: "式", basePrice: 0, quantity: 1, risk: "自訂", selected: true, tags: [], isCustom: true, note: "" });
            };
            const removeCustomItem = (catKey, index) => {
                itemDatabase[catKey].items.splice(index, 1);
            };

            // Sync Logic (含廠商數量與連動)
            const syncBudget = () => {
                let activeTags = new Set();
                let quantityMap = {}; 

                const collect = (obj, tagPrefix = '') => {
                    for (const key in obj) {
                        if (obj[key].checked) {
                            const tag = tagPrefix ? tagPrefix : key;
                            activeTags.add(tag);
                            if (obj[key].count) quantityMap[tag] = obj[key].count;
                        }
                    }
                };

                if (scope.method === '逆打') activeTags.add('topdown');
                if (scope.structure === '鋼骨' || scope.structure === 'SRC') activeTags.add('steel');
                if (scope.phasing.isPhased) activeTags.add('phasing');

                collect(scope.tempWorks);
                collect(scope.foundation.walls);
                collect(scope.foundation.supports);
                collect(scope.foundation.others);
                collect(scope.structural);
                collect(scope.finishing);
                collect(scope.equipment);

                classDTypes.forEach(t => { if(t.checked) t.tags.forEach(tag => activeTags.add(tag)); });

                for (const catKey in itemDatabase) {
                    itemDatabase[catKey].items.forEach(item => {
                        if(item.isCustom) return; 
                        const match = item.tags.some(t => activeTags.has(t));
                        if (match) {
                            item.selected = true;
                            item.autoSelected = true;
                            item.tags.forEach(t => { if (quantityMap[t]) item.quantity = quantityMap[t]; });
                        } else {
                            item.autoSelected = false;
                        }
                    });
                }
            };

            const grandTotal = computed(() => {
                let sum = 0;
                for (const k in itemDatabase) {
                    itemDatabase[k].items.forEach(i => { if (i.selected) sum += Math.round(i.basePrice * cpiFactor.value) * i.quantity; });
                }
                return sum;
            });

            const getCategoryTotal = (k) => itemDatabase[k].items.reduce((acc, i) => i.selected ? acc + Math.round(i.basePrice * cpiFactor.value) * i.quantity : acc, 0);
            const formatCurrency = (val) => '$' + val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

            const generateWord = async () => {
                const submissionMode = scope.phasing.isPhased ? "分段送審" : "一次送審";
                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({ text: `丁類危評預算書 (${projectInfo.name})`, heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER }),
                            
                            new Paragraph({ text: `一、專案摘要`, heading: HeadingLevel.HEADING_2 }),
                            new Paragraph({ text: `總預算: ${formatCurrency(grandTotal.value)}` }),
                            new Paragraph({ text: `CPI: ${cpiFactor.value}` }),
                            new Paragraph({ text: `送審模式: ${submissionMode}`, spacing: { after: 400 } }),

                            ...Object.keys(itemDatabase).flatMap(catKey => {
                                const items = itemDatabase[catKey].items.filter(i => i.selected);
                                if(items.length === 0) return [];
                                
                                const tableRows = items.map((item, i) => {
                                    const price = Math.round(item.basePrice * cpiFactor.value);
                                    return new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph((i+1).toString())] }),
                                            new TableCell({ children: [new Paragraph(item.name || "")] }),
                                            new TableCell({ children: [new Paragraph(item.quantity.toString())] }),
                                            new TableCell({ children: [new Paragraph(item.unit || "")] }),
                                            new TableCell({ children: [new Paragraph(formatCurrency(price))] }),
                                            new TableCell({ children: [new Paragraph(formatCurrency(price * item.quantity))] }),
                                        ]
                                    });
                                });
                                
                                const catTitle = itemDatabase[catKey].title;
                                
                                return [
                                    new Paragraph({ text: catTitle, heading: HeadingLevel.HEADING_2 }),
                                    new Table({
                                        rows: [
                                            new TableRow({ children: ["項次","名稱","數量","單位","單價","複價"].map(t=>new TableCell({children:[new Paragraph({text:t, bold:true})], shading:{fill:"EEEEEE"}})) }),
                                            ...tableRows
                                        ],
                                        width: { size: 100, type: WidthType.PERCENTAGE }
                                    }),
                                    new Paragraph({ text: "", spacing: { after: 200 } })
                                ];
                            })
                        ]
                    }]
                });
                const blob = await Packer.toBlob(doc);
                saveAs(blob, `預算書_${projectInfo.name}.docx`);
            };

            syncBudget();

            return { projectInfo, cpiFactor, scope, classDTypes, itemDatabase, grandTotal, formatCurrency, getCategoryTotal, syncBudget, addMainCategory, removeMainCategory, addCustomItem, removeCustomItem, generateWord };
        }
    }).mount('#app');
</script>
</body>
</html>